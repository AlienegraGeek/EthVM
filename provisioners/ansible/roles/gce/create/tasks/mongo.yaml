---

## -----
## Disks
## -----

- name: Check if Mongo SSD disks has been created
  command: "gcloud compute disks list --filter='name:{{ gcp.mongo.disks.name }}' --format='value(status)'"
  register: mongo_disks_created
  changed_when: false
  ignore_errors: yes

- name: Create Mongo SSD disk on GCP
  command: "gcloud compute disks create {{ gcp.mongo.disks.name }}-{{ item }} --size='{{ gcp.mongo.disks.size }}' --type='{{ gcp.mongo.disks.type }}' --zone='{{ gcp.zone }}'"
  changed_when: false
  when: mongo_disks_created.stdout == ""
  with_sequence: "start=1 end={{ gcp.mongo.instances }}"

## ---
## VMs
## ---

- name: Check if Mongo GCP instances has been created
  command: "gcloud compute instances list --filter='name:{{ name }}-{{ gcp.mongo.name }}' --format='value(status)'"
  register: instance_created
  changed_when: false
  ignore_errors: yes

- name: Set Mongo GCP instances names
  debug:
    msg: "{{ name }}-{{ gcp.mongo.name }}-{{ '%d'|format(item|int) }}"
  register: instance_names
  with_sequence:
    - "start=1 end={{ gcp.mongo.instances }}"
  when: instance_created.stdout == ""

- name: Create Mongo instances on GCP
  command: >
    gcloud compute instances create
    {{ hostvars.localhost.instance_names.results | map(attribute='msg') | list | join(' ') }}
    --zone="{{ gcp.zone }}"
    --image-family="{{ gcp.image_family }}"
    --image-project="{{ gcp.image_project }}"
    --machine-type="{{ gcp.mongo.machine_type }}"
    --boot-disk-size="{{gcp.boot_disk_size}}"
    --boot-disk-type="{{ gcp.boot_disk_type }}"
    --metadata-from-file=ssh-keys="{{ gcp.ssh_private_key_file }}"
    --tags="{{ gcp.mongo.name }}"
  changed_when: false
  when: instance_created.stdout == ""

- name: Attaching Mongo SDD disk to mongo instances on GCP
  loop: "{{ hostvars.localhost.instance_names.results | map(attribute='msg') | list }}"
  loop_control:
    index_var: i
  command: "gcloud compute instances attach-disk {{ item }} --disk='{{ gcp.mongo.disks.name }}-{{ i + 1 }}' --device-name='{{ gcp.mongo.disks.name }}-{{ i + 1 }}' --zone='{{ gcp.zone }}'"
  changed_when: false
  when: instance_created.stdout == ""

- name: "Enabling autodelete Mongo SSD disks on GCP"
  loop: "{{ hostvars.localhost.instance_names.results | map(attribute='msg') | list }}"
  loop_control:
    index_var: i
  command: "gcloud compute instances set-disk-auto-delete {{ item }} --disk='{{ gcp.mongo.disks.name }}-{{ i + 1 }}' --auto-delete --zone='{{ gcp.zone }}'"
  when: instance_created.stdout == "" and gcp.mongo.disks.autodelete == "true"

- name: Start Mongo instances if it's on TERMINATED status
  command: gcloud compute instances start "{{ name }}-{{ gcp.mongo.name }}"
  changed_when: false
  when: instance_created.stdout == "TERMINATED"
